name: Test Deployments

on:
  push:
    branches: [main]
    paths:
      - 'docker/**'
      - 'workers/**'
      - 'wrangler.jsonc'
      - '.github/workflows/test-deployments.yml'
  pull_request:
    paths:
      - 'docker/**'
      - 'workers/**'
      - 'wrangler.jsonc'
      - '.github/workflows/test-deployments.yml'

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # Docker Compose Tests
  # ============================================================================
  docker-compose:
    name: Docker Compose
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build mdbook-htmx
        run: cargo build --release

      - name: Create example book output
        run: |
          mkdir -p book/htmx/pages book/htmx/fragments
          echo '<!DOCTYPE html><html><body><h1>Test</h1></body></html>' > book/htmx/index.html
          echo '<!DOCTYPE html><html><body><h1>Page</h1></body></html>' > book/htmx/pages/index.html
          echo '<h1>Fragment</h1>' > book/htmx/fragments/index.html

      - name: Start services
        run: docker compose -f docker/compose.yml up -d

      - name: Wait for healthy
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:8080/health; then
              echo "Service is healthy"
              exit 0
            fi
            echo "Waiting for service... ($i/30)"
            sleep 1
          done
          echo "Service did not become healthy"
          docker compose -f docker/compose.yml logs
          exit 1

      - name: Test static serving
        run: |
          curl -sf http://localhost:8080/ | grep -q "Test"
          echo "Static serving: OK"

      - name: Test fragment routing
        run: |
          curl -sf -H "HX-Request: true" http://localhost:8080/fragments/ | grep -q "Fragment"
          echo "Fragment routing: OK"

      - name: Cleanup
        if: always()
        run: docker compose -f docker/compose.yml down -v

  # ============================================================================
  # Helm Chart Tests
  # ============================================================================
  helm-lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: aRustyDev/helm-charts
          path: helm-charts

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Lint chart
        run: helm lint helm-charts/charts/mdbook-htmx

      - name: Template chart
        run: helm template test helm-charts/charts/mdbook-htmx --debug

      - name: Template with ingress
        run: |
          helm template test helm-charts/charts/mdbook-htmx \
            --set ingress.enabled=true \
            --set ingress.hosts[0].host=docs.example.com \
            --set ingress.hosts[0].paths[0].path=/ \
            --set ingress.hosts[0].paths[0].pathType=Prefix

  helm-verify:
    name: Helm Verify (OCI + Cosign)
    runs-on: ubuntu-latest
    env:
      CHART_REGISTRY: ghcr.io/arustydev/charts
      CHART_NAME: mdbook-htmx
      CHART_VERSION: 0.2.1
    steps:
      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Verify chart signature
        run: |
          echo "üîè Verifying signature for $CHART_NAME:$CHART_VERSION..."
          cosign verify $CHART_REGISTRY/$CHART_NAME:$CHART_VERSION \
            --certificate-identity-regexp="https://github.com/aRustyDev/helm-charts/.*" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com"
          echo "‚úÖ Signature verification passed"

      - name: Pull and inspect chart from OCI
        run: |
          echo "üì¶ Pulling chart from OCI registry..."
          helm pull oci://$CHART_REGISTRY/$CHART_NAME --version $CHART_VERSION

          echo "üìã Chart contents:"
          tar -tzf ${CHART_NAME}-${CHART_VERSION}.tgz

          echo "‚úÖ OCI pull successful"

      - name: Verify chart provenance (SLSA)
        continue-on-error: true
        run: |
          echo "üîç Checking for SLSA provenance attestation..."
          cosign verify-attestation $CHART_REGISTRY/$CHART_NAME:$CHART_VERSION \
            --type slsaprovenance \
            --certificate-identity-regexp="https://github.com/aRustyDev/helm-charts/.*" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com" || \
          echo "‚ö†Ô∏è No SLSA provenance attestation found (optional)"

  helm-install:
    name: Helm Install (kind)
    runs-on: ubuntu-latest
    needs: [helm-lint, helm-verify]
    env:
      CHART_REGISTRY: ghcr.io/arustydev/charts
      CHART_NAME: mdbook-htmx
      CHART_VERSION: 0.2.1
    steps:
      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Verify chart signature before install
        run: |
          cosign verify $CHART_REGISTRY/$CHART_NAME:$CHART_VERSION \
            --certificate-identity-regexp="https://github.com/aRustyDev/helm-charts/.*" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com"

      - name: Create kind cluster
        uses: helm/kind-action@v1

      - name: Create test content ConfigMap
        run: |
          kubectl create configmap mdbook-content \
            --from-literal=index.html='<!DOCTYPE html><html><body>Test</body></html>'

      - name: Install chart from OCI registry
        run: |
          helm install test oci://$CHART_REGISTRY/$CHART_NAME \
            --version $CHART_VERSION \
            --set contentConfigMap=mdbook-content \
            --wait --timeout 2m

      - name: Verify deployment
        run: |
          kubectl get pods
          kubectl rollout status deployment/test-mdbook-htmx --timeout=60s

      - name: Port forward and test
        run: |
          kubectl port-forward svc/test-mdbook-htmx 8080:80 &
          sleep 3
          curl -sf http://localhost:8080/health
          echo "Health check: OK"

      - name: Cleanup
        if: always()
        run: helm uninstall test || true

  # ============================================================================
  # Cloudflare Worker Tests
  # ============================================================================
  cloudflare-typecheck:
    name: Cloudflare TypeCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: workers
        run: npm install

      - name: Type check
        working-directory: workers
        run: npm run typecheck
